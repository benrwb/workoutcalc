<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Workout calculator</title>
    <style type="text/css">
        #maintable input {
            text-align: right;
        }

        body {
            font-family: arial;
        }

        textarea {
            font-family: consolas, monospace;
        }

        input[type=number] {
            width: 80px;
        }
    </style>
</head>
<body>

    <b>Exercise name:</b>
    <input type="text" id="exName" oninput="calc()" />
    <button onclick="clearForm()">Clear</button>

    <br /><br />
    <table id="maintable">
        <thead>
            <tr>
                <th>Set</th>
                <th>Weight</th>
                <th>Reps</th>
                <th>Score</th>
                <th>Gap</th>
            </tr>
        </thead>
        <tbody id="tblBody">
            <!-- table rows will be inserted here -->
        </tbody>
    </table>

    <template id="tablerow">
        <tr>
            <td>1</td>
            <td><input size="3" type="number" oninput="calc()" step="any" /></td>
            <td><input size="3" type="number" oninput="calc()" /></td>
            <td style="text-align: right"></td>
            <td><input maxlength="3" type="number" oninput="calc()" /></td>
        </tr>
    </template>


    <!--<br /></br />
    <button onclick="calc()">Calculate</button>
    <br /><br />-->

    
    <textarea rows="5" cols="45" id="txtOutput" name="txtOutput"></textarea>
    
    <br />
    Mail to: <input type="email" id="email" name="email" size="25" onchange="calc()" />
    <a href="" id="email_link">Send email</a>


    <script type="text/javascript">
        
        function getStorage(key) {
            // retrieve a value from localStorage, or null if the key does not exist.
            if (localStorage[key] == null) return ""; // == matches null or undefined
            return localStorage[key];
        }

        // BEGIN add table rows (using template)
        var template = document.getElementById("tablerow").content;
        var tds    = template.querySelectorAll("td");
        var inputs = template.querySelectorAll("input");

        for (var i = 1; i <= 10; i++) {
            tds[0].textContent = i;
            inputs[0].id = "weight" + i;
            inputs[0].name = "weight" + i;
            inputs[1].id = "reps" + i;
            tds[3].id    = "score" + i;
            inputs[2].id = "gap" + i;
            // restore saved data from localstorage...
            inputs[0].value = getStorage("weight" + i);
            inputs[1].value = getStorage("reps" + i);
            inputs[2].value = getStorage("gap" + i);

            var tbody = document.getElementById("tblBody");
            tbody.appendChild(document.importNode(template, true));
        }
        // END add table rows
        document.getElementById("exName").value = getStorage("exName"); // restore saved name from localStorage



        function pad(str, len) {
            // Pads the string so it lines up correctly
            var xtra = len - str.length;
            return " ".repeat((xtra / 2) + (xtra % 2))
                 + str
                 + " ".repeat(xtra / 2);
        }

        function calc() {
            // Calculate score and generate output text
            var totalScore = 0;
            var weights = "kg";
            var reps    = "x ";
            var gaps    = "🕘  ";

            for (var i = 1; i <= 10; i++) {
                var w = document.getElementById("weight" + i).value;
                var r = document.getElementById("reps" + i).value;
                var g = document.getElementById("gap" + i).value;

                var score = Number(w) * Number(r);
                document.getElementById("score" + i).innerText = score == 0 ? "" : score.toString();

                if (score > 0) {
                    var len = Math.max(w.length, r.length, g.length);
                    weights += "  " + pad(w, len);
                    reps    += "  " + pad(r, len);
                    gaps    += "  " + pad(g, len);
                    totalScore += score;
                }

                // save to local storage
                localStorage["weight" + i] = w;
                localStorage["reps" + i] = r;
                localStorage["gap" + i] = g;
            }

            var exName = document.getElementById("exName").value;
            localStorage["exName"] = exName; // save exercise name to localStorage

            var txt = document.getElementById("txtOutput");
            txt.value = "1. " + exName + "\n  " + weights.trim() + "\n  " + reps.trim() + "\n  " + gaps.trim() + "\n  Volume: " + totalScore;


            var link = document.getElementById("email_link");
            var to = document.getElementById("email").value;
            link.href = "mailto:" + to + "?subject=workout&body=" + encodeURIComponent(txt.value);
        }

        // POSSIBLE TODO: Cursor keys to move between inputs

        function clearForm() {
            if (confirm("Are you sure you want to clear the whole form?")) {
                document.getElementById("exName").value = "";
                for (var i = 1; i <= 10; i++) {
                    document.getElementById("weight" + i).value = "";
                    document.getElementById("reps" + i).value = "";
                    document.getElementById("gap" + i).value = "";
                }
                calc();
            }
        }

        function postform() {
            var form = document.getElementById("emailform");
            form.action = "mailto:" + document.getElementById("email").value;
            form.submit();
        }


        calc(); // calculate on page load
    </script>
</body>
</html>
