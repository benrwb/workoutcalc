<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Workout calculator</title>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.0/knockout-min.js"></script>
    <script type="text/javascript" src="https://cdn.rawgit.com/SteveSanderson/knockout-es5/master/dist/knockout-es5.min.js"></script>
    <style type="text/css">
        body {
            font-family: arial;
            font-size: 12pt;
        }
        #maintable {
            border-collapse: collapse;
            margin: 5px 0px;
        }
        #maintable td {
            border: solid 1px silver;
            text-align: right;
        }
        td.borderless {
            border-left-color: white !important;
            border-top-color: white !important;
            border-bottom-color: white !important;
            padding-right: 5px;
        }
        td.borderless2 {
            /* For top-right 'Gap' box */
            border-left-color: white !important;
            border-right-color: white !important;
            border-top-color: white !important;
            padding-right: 5px;
        }
         td.borderless3 {
             /* For 'Score' box on top-row (no gap) */
            border-color: white !important;
            padding-right: 5px;
        }
        #maintable input {
            text-align: right;
            border: none;
        }
        input {
            font-size: 12pt;
            border: solid 1px #a9a9a9;
            padding: 2px 1px;
        }


        textarea {
            border: solid 1px #a9a9a9;
            font-family: consolas, monospace;
            white-space: pre; /* don't wrap text */
        }

        input[type=number] {
            width: 80px;
        }


        button.pagebtn {
            padding: 10px 20px;
        }
        button.highlight {
            background-color: gold;
        }
    </style>
</head>
<body>

    

    <span data-bind="foreach: Exercises">
        <button class="pagebtn" data-bind="text: ExerciseId + 1, click: $root.SetPage, css: { highlight: $root.CurrentPage == ExerciseId }"></button>
    </span>
    <button data-bind="click: Clear" style="padding: 10px; margin-left: 120px">Clear</button>

    <br /><br />
    <div data-bind="foreach: Exercises">
        <div data-bind="visible: $root.CurrentPage == ExerciseId">
            <b>Exercise #<span data-bind="text: ExerciseId + 1"></span>:</b>
            <input type="text" data-bind="value: ExerciseName" size="23" />

            <table id="maintable">
                <thead>
                    <tr>
                        <th>Set</th>
                        <th>Weight</th>
                        <th>Reps</th>
                        <th>Score</th>
                        <th>Gap</th>
                    </tr>
                </thead>
                <tbody data-bind="foreach: Sets">
                    <tr>
                        <td data-bind="text: SetNumber" class="borderless"></td>
                        <td><input size="3" type="number" data-bind="value: Weight" step="any" /></td>
                        <td><input size="3" type="number" data-bind="value: Reps" /></td>
                        <td style="text-align: right" data-bind="text: Score, css: { borderless: SetNumber != '1', borderless3: SetNumber == '1' }"></td>
                        <td data-bind="css: { borderless2: SetNumber == '1' }">
                            <input maxlength="3" type="number" data-bind="value: Gap, visible: SetNumber != '1'" />
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    




    
    <textarea rows="6" cols="45" data-bind="value: OutputText" readonly="readonly"></textarea>
    
    <br />
    Mail to: <input type="email" size="23" data-bind="value: EmailTo" />
    <a data-bind="attr: { href: EmailLink }">Send email</a>


    <script type="text/javascript">
        
        var NUM_EX = 3;
        var NUM_SETS = 8;

        function getStorage(key) {
            // retrieve a value from localStorage, or "" (empty string) if the key does not exist.
            if (localStorage[key] == null) return ""; // == matches null or undefined
            return localStorage[key];
        }

       function pad(str, len) {
           // Pads the string so it lines up correctly
           var xtra = len - str.length;
           return " ".repeat((xtra / 2) + (xtra % 2))
                + str
                + " ".repeat(xtra / 2);
       }


       // // POSSIBLE TODO: Cursor keys to move between inputs



       function AppViewModel() {
           var self = this;

           self.CurrentPage = 0;

           self.SetPage = function (data) {
               self.CurrentPage = data.ExerciseId;
            }

           self.EmailTo = getStorage("emailTo");

           self.Exercises = [];

           for (var x = 0; x < NUM_EX; x++) {
               var ex = {
                   "ExerciseId": x,
                   "ExerciseName": getStorage("exName" + x.toString()),
                   "Sets": []
               }
               for (var s = 0; s < NUM_SETS; s++) {
                   var setId = x.toString() + "_" + s.toString();
                   var set = {
                       "SetNumber": (s + 1).toString(),
                       "Weight": getStorage("weight" + setId),
                       "Reps": getStorage("reps" + setId),
                       "Gap": getStorage("gap" + setId),
                       "Score": 0
                   }
                   ko.track(set);
                   // Score is set in OutputText // ko.defineProperty(set, 'Score', function () { return Number(this.Weight) * Number(this.Reps) });
                   ex.Sets.push(set);
               }
               ko.track(ex);
               self.Exercises.push(ex);
           }


           ko.defineProperty(self, 'OutputText', function () {
               // POSSIBLE TODO: Throttle this, e.g. ko.getObservable(self, 'OutputText').extend({ throttle: 500 });

               // Calculate score and generate output text
               var output = "";
               var totalVolume = 0;

               for (var x = 0; x < NUM_EX; x++) {
                   var weights = "kg";
                   var reps = "x ";
                   var gaps = "🕘  ";
                   var exerciseVolume = 0;
                   for (var s = 0; s < NUM_SETS; s++) {

                       var w = self.Exercises[x].Sets[s].Weight;
                       var r = self.Exercises[x].Sets[s].Reps;
                       var g = (s == (NUM_SETS - 1)) ? "" : self.Exercises[x].Sets[s + 1].Gap; // use the next one down

                       var score = Number(w) * Number(r);
                       self.Exercises[x].Sets[s].Score = score == 0 ? "" : score.toString();

                       if (score > 0) {
                           var len = Math.max(w.length, r.length, g.length);
                           weights += "  " + pad(w, len);
                           reps += "  " + pad(r, len);
                           gaps += "  " + pad(g, len);
                           exerciseVolume += score;
                           totalVolume += score;
                       }
                   }

                   if (exerciseVolume > 0) {
                       var exName = self.Exercises[x].ExerciseName;
                       output += (x + 1).toString() + ". " + exName + "\n  "
                           + weights.trim() + "\n  "
                           + reps.trim() + "\n  "
                           + gaps.trim() + "\n  "
                           + "Volume: " + exerciseVolume
                           + "\n\n";
                   }
               }
               output += "Total volume: " + totalVolume;

               self.SaveToLocalStorage();

               return output;
           });

           ko.defineProperty(self, 'EmailLink', function () {
               return "mailto:" + self.EmailTo + "?subject=workout&body=" + encodeURIComponent(self.OutputText);
           });

           self.SaveToLocalStorage = function () {
               for (var x = 0; x < NUM_EX; x++) {
                   localStorage["exName" + x.toString()] = self.Exercises[x].ExerciseName; // save exercise name to localStorage
                   for (var s = 0; s < NUM_SETS; s++) {
                       var setId = x.toString() + "_" + s.toString();
                       localStorage["weight" + setId] = self.Exercises[x].Sets[s].Weight;
                       localStorage["reps" + setId] = self.Exercises[x].Sets[s].Reps;
                       localStorage["gap" + setId] = self.Exercises[x].Sets[s].Gap;
                   }
               }
               localStorage["emailTo"] = self.EmailTo;
           }

           self.Clear = function() {
               if (confirm("Are you sure you want to clear the whole form?")) {
                   for (var x = 0; x < NUM_EX; x++) {
                       self.Exercises[x].ExerciseName = "";
                       for (var s = 0; s < NUM_SETS; s++) {
                           self.Exercises[x].Sets[s].Weight = "";
                           self.Exercises[x].Sets[s].Reps = "";
                           self.Exercises[x].Sets[s].Gap = "";
                       }
                   }
                   // note: email address is not cleared
               }
           }

           ko.track(self);
       }
            

            

        ko.applyBindings(new AppViewModel());
    </script>
</body>
</html>
